# 设计计划（基础优先，含可操作的验证方法）

## 基础设计与前端框架
1. **初始化前端工程**：用 Vite+React+TS 创建项目，添加 Zustand、Canvas/SVG 依赖，保留 npm scripts（dev/build/lint）。  
   - 验证：本地运行开发服务器能打开空白页，执行构建和 lint 均无错误。
2. **路由与骨架占位**：主界面只保留两个可点按钮（捕物、珍藏），捕物页划分左预览/右编辑/下物品栏，珍藏页网格占位。  
   - 验证：手动点击确认只有这两个按钮可导航，三页布局区域与比例符合 PRD（左约 60%，右约 40%）。
3. **全局状态模型**：定义上传文件、预览 URL、检测框列表、当前选中框 ID、标签数据（名称/类别/描述/能量/生命/时间/标签位置与缩放）、保存状态。  
   - 验证：用固定 2–3 个框的 mock（含面积），断言默认选中 ID = 面积最大；切换选中 ID 状态正确更新。
4. **捕物页静态 UI**：左侧画布含识别框层和标签层容器，右侧编辑面板区块，右下物品栏格子，底部更换/保存按钮，右上返回。  
   - 验证：视觉对照 PRD 草图或 Figma，占位与比例一致；无上传时显示空态区域。
5. **上传入口与空态**：未上传时显示木框占位和上传按钮，支持点击/拖拽接收图片并生成本地预览。  
   - 验证：拖拽与文件选择各操作一次，状态内有文件信息，预览切换为新图，空态消失。

## 预览与交互基础
6. **前端像素化预览（真实模型）**：上传后立即调用 Nano Banana 生图模型（提示词见步骤 17）生成星露谷风像素预览，保持构图不变；请求期间显示加载态，失败时回退到本地固定像素滤镜占位。  
   - 验证：上传后出现加载提示，成功返回像素风预览且物体位置/比例一致；模拟超时/失败时自动切换本地滤镜占位并给出提示。
7. **Mock 检测框**：上传后生成多框假数据并渲染，默认选最大框。  
   - 验证：显示 3–5 个框，最大框高亮；查看状态记录框坐标与选中 ID。
8. **物体选择三联动**：物品栏格子和画布框点击都能切换当前物体，同时更新框高亮、右侧表单、标签内容。  
   - 验证：依次点击不同格子和框，三处同步变化且无明显延迟，表单初值来自该物体草稿（或默认）。
9. **标签编辑联动**：名称/类别/描述/能量/生命/时间输入实时写入状态并更新标签渲染。  
   - 验证：修改文本后标签即时变更；数值步进上下边界测试（连点 300 次不超过 200，减到 -10 不低于 0）；时间改动后文本同步。
10. **标签拖拽与缩放**：标签可拖动且不越界，角落把手可缩放，有最小/最大限制。  
    - 验证：拖到边缘会被限制或回弹，缩放不会覆盖全图，点击画布空白能取消选中。
11. **时间组件**：右上时间 UI 读取状态时间驱动指针角度，提供“一键同步当前时间”。  
   - 验证：修改小时/分钟指针跟随；点击同步后文本与指针对齐系统时间（默认浏览器本地时区）。
12. **底部按钮逻辑**：更换照片前如有改动弹确认，保存按钮在无选中物体或检测失败时置灰。  
   - 验证：编辑后点更换弹出确认；无框时保存按钮灰色且不可点。
13. **输入尺寸规范**：上传后按设定区间调整分辨率（当前建议长边压到 1280px，上限 1600px，下限 720px），保持比例不变，过大缩小、过小放大，后续可按观感再调。  
    - 验证：输入超大/超小图片后，预览与导出尺寸落在区间内，画面比例保持。

## 后端与接口
14. **FastAPI 初始化与健康检查**：建立服务并提供健康检查路由。  
    - 验证：启动后健康检查返回 200 与版本信息。
15. **第三方检测客户端层**：封装检测 API（重试/限速/错误兜底），输出标准框列表；供应商选用 Azure Computer Vision，向用户申请 API key。  
    - 验证：模拟 401、429、超时返回友好错误且不崩溃；成功路径返回多框包含坐标/置信度/ID；已记录 Azure 终端与 key。
16. **文案生成服务**：封装大模型 API 提供名称/描述生成与重生，失败用星露谷口吻模板（基于星露谷物品描述风格汇总）。  
    - 验证：断网或限流时返回模板文本，正常时文案 1–2 句；模板符合星露谷风格（短句、温柔、生活感）。
17. **像素风生成/合成管线**：使用固定提示词“将图片中的主要物品转换成《星露谷物语》风格的 16 位像素艺术。严格保持物体原有的轮廓和比例，不要改变其形态。使用游戏特有的温暖、朴实调色板，块状精灵图纹理，增加复古光影，使其看起来像可以直接放入游戏中的素材。”调用 Nano Banana 生图模型产出高保真像素风图（像素块大小不可调，构图不变），再用 Pillow 叠加标签、时间、固定金币 88888888；与前端预览保持一致性。  
   - 验证：同一输入运行两次输出一致（哈希/尺寸），与前端预览/参考像素风一致，元素位置正确；记录提示词与模型版本。
18. **存储与数据库**：Supabase Storage 仅保存最终合成图；数据库记录作品 ID、用户 ID、合成图 URL（及系统创建时间用于排序）。  
    - 验证：保存后能看到合成图 URL，数据库行含作品 ID、用户 ID、URL、创建时间，字段类型正确。
19. **接口契约定义**：规划 `/detect`、`/generate-text`、`/save-artwork`、`/artworks` 输入输出字段与错误格式，明确需要用户 ID。  
    - 验证：契约测试覆盖成功与错误结构（标准错误码/消息），字段名/类型与前端一致。

## 联调与完善
20. **前端接入真实检测**：上传后调用 `/detect`，0 框显示“没看清…”空态，超过 20 框分页/滚动。  
    - 验证：模拟 0 框与 25 框响应，空态和分页按钮展示正确，默认选中仍为最大框（无论在第几页）。
21. **描述生成按钮**：描述区域接入 `/generate-text`，支持重生覆盖，超时兜底模板。  
    - 验证：连续点击两次内容被覆盖不叠加，故障时显示模板且有提示。
22. **保存流程**：点击“保存至珍藏箱”调用 `/save-artwork`（含用户 ID 和最终合成图），按钮变“保存中…”并禁用，成功弹提示含“去珍藏看看/继续捕物”，失败提示可重试。  
    - 验证：网络延迟下按钮保持禁用；快速连点无法触发多次保存；成功弹窗出现两按钮，失败弹出重试对话。
23. **珍藏列表**：珍藏宝页调用 `/artworks` 展示缩略图网格（最终图缩略），按创建时间倒序显示，支持简单分页（页码 1/2/3/4）。  
    - 验证：空列表显示空态文案，点击缩略图打开大图层，右上返回能关闭且回到原滚动位置；默认最新在前。
24. **作品查看**：大图显示合成图，含时间/金币/标签结果，右上返回回列表。  
    - 验证：与保存前预览截图在位置和样式上匹配。
25. **草稿保留与换图重置**：切换物体保留各自编辑草稿，更换照片重置所有状态。  
    - 验证：编辑物体 A 后切到 B 再回 A 内容仍在；更换照片后表单回默认且框重算；明确更换后旧图草稿不残留。
26. **错误与边界处理**：上传非图片、检测失败、存储失败、网络超时都给星露谷风提示与重试/取消。  
    - 验证：逐一注入上述错误，检查提示语与按钮状态符合预期。
27. **像素一致性**：比对前端预览与后端合成结果的像素化效果。  
    - 验证：保存后下载作品，与保存前截图做像素块对比（允许轻微压缩差异），可用脚本计算块平均色差。
28. **配置安全**：API 密钥仅来自环境变量，按需向用户申请（检测/生成接口），本地与线上配置分离。  
    - 验证：无密钥时服务启动失败并输出清晰错误；接入前已向用户确认供应商与 key。
29. **端到端验收**：完整跑“主界面→捕物上传→选物体→生成名称/描述→调时间/数值→拖拽标签→保存→珍藏查看”流程，对照验收清单逐项勾选（唯一标签、三处联动、金币固定、指针随时间变）。  
    - 验证：使用明确验收表逐项勾选，无缺项后才标记通过。
